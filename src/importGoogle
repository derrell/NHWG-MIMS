#!/bin/bash -e
# ## Copyright 2017 Marshall E. Giguere
##
##   Licensed under the Apache License, Version 2.0 (the "License");
##   you may not use this file except in compliance with the License.
##   You may obtain a copy of the License at
##
##       http://www.apache.org/licenses/LICENSE-2.0
##
##   Unless required by applicable law or agreed to in writing, software
##   distributed under the License is distributed on an "AS IS" BASIS,
##   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
##   See the License for the specific language governing permissions and
##   limitations under the License.


# Calls GAM to pull a JSON dump of the entire wing user database,
# and imports it into the wing NHWG database on mongoDB.  This script
# is intended "mostly" to be run as a cron/batch job.
#
# Note: You will need to update the variables to point to the utilities.
#
# History:
# 15Jul17 MEG Allow import to user specified collection and database.
# 10Jul17 MEG Changed json file filter now uses sed for speed.
# 09Jul17 MEG Created.
#

# Database
DB=NHWG
# Host
HOST=localhost
# Collection in DB to import into
COLL=Google
# GAM command
GAM=/usr/local/bin/gam
# Import command
IMP=/usr/bin/mongoimport
# JSON output file
JSON=./$COLL.json
# Log file
LOG=./log/GAM.log

# options
OPTS="c:d:h?"

USAGE="Usage: $(basename $0) [$OPTS]\n
\tDownload and import Google member data\n
\tc - collection ($COLL)\n
\td - database ($DB)\n
\th|? - this help\n"

while getopts $OPTS o; do
    case $o in
	c) COLL=$OPTARG;;
	d) DB=$OPTARG;;
	h|?) echo -e $USAGE;exit 1;;
	*) echo -e $USAGE;exit 1;;
    esac
done
shift $(($OPTIND - 1))

echo "Downloading Google members"
$GAM redirect stderr $LOG info users all users formatjson | sed -r -f ./jsonfix.sed >$JSON
cat $LOG
echo "Importing members into MongoDB NHWG"
$IMP --host $HOST --db $DB --collection $COLL --drop --type json --file $JSON
echo "Done."
