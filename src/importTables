#!/bin/bash -e
## Copyright 2017 Marshall E. Giguere
##
##   Licensed under the Apache License, Version 2.0 (the "License");
##   you may not use this file except in compliance with the License.
##   You may obtain a copy of the License at
##
##       http://www.apache.org/licenses/LICENSE-2.0
##
##   Unless required by applicable law or agreed to in writing, software
##   distributed under the License is distributed on an "AS IS" BASIS,
##   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
##   See the License for the specific language governing permissions and
##   limitations under the License.


#
# Import CAPWATCH tables into MongoDB. User may change the database or
# provide a list of substitute tables to import.
# Note 1: Subsitute tables must have a companion .types file for mongoimport
# Note 2: Files must have been preprocessed with getTables before importing
#         or similar to convert dates to MicroSoft SQL date format.
#
# History:
# 12Aug18 MEG Index script config variable added
# 20Jul18 MEG Index CAPWATCH collections.
# 24Jun18 MEG Check for missing import files.
# 25Mar18 MEG Now imports Commanders table.
# 22Jan18 MEG Move MongoDB login cred's to separate file.
# 13Jul17 MEG User option to change database and substitute tables.
# 03Jul17 MEG Created.
#

# MongoDB login credentials file path
CREDS=./importercreds

# Database to connect to
DB=NHWG

# Mongo import tool
IMPORT=mongoimport

# MongoDB script to index CAPWATCH collections
INDEXSCRIPT="./indexCAPWATCH.js"

# CAPWATCH tables to import
TABLES="Commanders Member MbrContact MbrAddresses MbrAchievements DutyPosition"

# Path to column type def's for each table
TYPEPATH=$HOME/work/NHWG/MIMS

# load Mongo MIMS importer credentials
. $CREDS

# Command options
OPTS="d:t:h?"

# Help text
USAGE="Usage: $(basename $0) [$OPTS] [table table...] \n
\tImport CAPWATCH tables into MongoDB. \n
\td - database ($DB)\n
\th|? - help \n
\tt - path to .type files ($TYPEPATH)\n
\tTABLES=$TABLES\n"

while getopts $OPTS o; do
    case $o in
	d) DB=$OPTARG;;
	t) TYPEPATH=$OPTARG;;
	h|?) echo -e $USAGE;exit 1;;
	*) echo -e $USAGE;exit 1;;
    esac
done
shift $(($OPTIND - 1))

# Check for substituted list of tables to import
if [ $# -ge 1 ]; then
    TABLES=$@
fi

# remove old import failure flag if it exists
if [ -f "IMPORTFAILED" ]; then
    /bin/rm -f IMPORTFAILED
fi

for t in $TABLES; do
    if [ ! -f "$t.csv" ]; then
	echo "ERROR: file not found: $t.csv"
	touch IMPORTFAILED
	continue
    fi
    $IMPORT --db $DB --authenticationDatabase=$DB --username=$MONGOUID \
--password=$MONGOPASS --collection $t --drop --type csv --columnsHaveTypes \
	--fieldFile $TYPEPATH/$t.types --file $t.csv
done


# create indices for collections
echo "Index CAPWATCH collection"
mongo --quiet --authenticationDatabase=$DB --username=$MONGOUID \
      --password=$MONGOPASS $INDEXSCRIPT
echo "Done."
