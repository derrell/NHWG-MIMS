#!/bin/bash
# jobexec is designed to be run as a cron job, when awakened it
# scans the JOBS directory for .job files.  The jobs are executed in sort
# order, successfully completed job files are move to the completed
# directory.  Job files that begin with "HOLD-" | "hold-"  are skipped. Jobs
# that run with errors are moved from the queue to completed and errors
# are reported, this is to prevent unintended re-runs.
#
# History:
# 02Sep17 MEG Jobs that have errors now sent to "completed" regardless.
# 07Jul17 MEG Created.
#

# Location of config file
# you should move this to /etc/defaults/ and make it owned by root
CONF=/home/meg/work/NHWG/MIMS/jobexec.conf

# check for config file, source configuration if it exists
if [ ! -f $CONF ]; then
    echo $(basename $0)": Missing config file: $CONF"
    exit 1
fi
# source config
. $CONF

# Set default locations if conf file missing
# Path to .job files
 [ -z $JOBS ] && JOBS=./job

# location for completed jobs
 [ -z $COMPJOBS ] && COMPJOBS=$JOB/completed

# Check that jobs directory exists before we do anything
if [ ! -d $JOBS ]; then
    echo ERROR: jobs directory: $JOBS not found.
    exit 1
fi

# move to the jobs directory before further action
cd $JOBS

# Make sure completed job directory exists, if not create it
if [ ! -d $COMPJOBS ]; then
    /bin/mkdir -p $COMPJOBS
fi

# loop over job files in sort order, skip files ^HOLD-*

for j in *.job; do
    echo $j|grep -qi '^hold-' && continue
    /bin/bash <$j
    /bin/mv $j $COMPJOBS
    if [ $? != "0" ]; then
	echo "WARNING: Job: $j completed with errors."
    fi
done
